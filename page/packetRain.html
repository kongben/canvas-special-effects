<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      html,
      body {
        margin: 0;
        overflow: hidden;
        width: 100%;
        height: 100%;
        cursor: none;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
  </body>
  <script>
    let canvas = document.querySelector("#canvas");
    let ctx = canvas.getContext("2d");
    WIDTH = document.documentElement.clientWidth;
    HEIGHT = document.documentElement.clientHeight;
    let packetArr = [];
    let getNum = 0;
    canvas.width = WIDTH;
    canvas.height = HEIGHT;
    function Packet(x, y) {
      this.x = x;
      this.y = y;
      this.s = 6;
    }
    function paintNum() {
      ctx.font = "48px serif";
      ctx.fillText(`${getNum}个`, 10, 50);
    }
    Packet.prototype.isIntersect = function(point, el) {
      const distanceX = point.x >= el.x && point.x <= this.img.width + el.x;
      const distanceY = point.y >= el.y && point.y <= this.img.height + el.y;
      return distanceX && distanceY;
    };

    Packet.prototype.draw = function() {
      let img = (this.img = new Image());
      let x = this.x;
      let y = this.y;
      this.img.src = "./asset/packet.png";
      ctx.beginPath();
      ctx.drawImage(img, x, y);
      ctx.closePath();
      ctx.fill();
    };

    canvas.addEventListener("click", e => {
      const pos = {
        x: e.clientX,
        y: e.clientY
      };
      // 所有点中的红包都存这
      const clickedPackets = [];
      packetArr.forEach((el, index) => {
        if (el.isIntersect(pos, el)) {
          clickedPackets.push({
            x: e.clientX,
            y: e.clientY,
            // 索引很重要，用于删除this.coinArr内的该金币
            index: index
          });
        }
      });
      if (clickedPackets.length > 0) {
        getNum++;
        packetArr.splice(clickedPackets[0].index, 1);

      }
    });

    Packet.prototype.move = function() {
      if (this.y <= HEIGHT) {
        this.y += this.s;
      }
    };

    function paint() {
      ctx.clearRect(0, 0, WIDTH, HEIGHT);
      for (var i = 0; i < packetArr.length; i++) {
        if (packetArr[i].y < HEIGHT) {
          packetArr[i].draw();
          packetArr[i].move();
        }
        
      }
    }
    function PacketList() {
      const num = 10;
      let i = 1;
      let interval = setInterval(() => {
        i++;
        packetArr.push(new Packet(Math.random() * (WIDTH - 50), 0)); //在视图内红包
        if (i > num) {
          clearInterval(interval);
        }
      }, 1000);
    }

    function loop() {
      requestAnimationFrame(loop);
      paint();
      paintNum();
    }
    loop();
    PacketList();
  </script>
</html>
